<div class="page-container">
  <mat-toolbar color="primary" class="toolbar">
    <span>ğŸ“Š Analytics Dashboard</span>
    <span class="spacer"></span>
    <span class="hint"> Selecciona fuente y configura tus grÃ¡ficas con opciones avanzadas</span>
  </mat-toolbar>

  <div class="builder-grid">
    <mat-card class="config-card">
      <mat-card-header>
        <mat-card-title>âš™ï¸ Constructor de GrÃ¡ficas</mat-card-title>
        <mat-card-subtitle> Personaliza cada aspecto de tu visualizaciÃ³n</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="form" class="builder-form">
          <mat-form-field appearance="outline">
            <mat-label>Fuente de datos</mat-label>
            <mat-select formControlName="dataSource">
              <mat-option value="finance">ğŸ’° Finanzas</mat-option>
              <mat-option value="tasks">âœ… Tareas</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Tipo de grÃ¡fica</mat-label>
            <mat-select formControlName="chartType">
              <mat-option value="line">ğŸ“ˆ LÃ­nea</mat-option>
              <mat-option value="bar">ğŸ“Š Barras</mat-option>
              <mat-option value="pie">ğŸ¥§ Pie</mat-option>
              <mat-option value="doughnut">ğŸ© Dona</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Agrupar por: opciones segÃºn fuente -->
          <mat-form-field *ngIf="form.value.dataSource === 'finance'" appearance="outline">
            <mat-label>Agrupar por</mat-label>
            <mat-select formControlName="groupBy">
              <mat-option value="timeline">ğŸ“… PerÃ­odo</mat-option>
              <ng-container *ngIf="form.value.includeExpenses && !form.value.includeIncomes">
                <mat-option value="category">ğŸ·ï¸ CategorÃ­a</mat-option>
              </ng-container>
              <ng-container *ngIf="form.value.includeIncomes && !form.value.includeExpenses">
                <mat-option value="source">ğŸ’µ Fuente</mat-option>
              </ng-container>
              <mat-option value="member">ğŸ‘¤ Miembro</mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field *ngIf="form.value.dataSource === 'tasks'" appearance="outline">
            <mat-label>Agrupar por</mat-label>
            <mat-select formControlName="groupBy">
              <mat-option value="status">ğŸ”„ Estado</mat-option>
              <mat-option value="category">ğŸ·ï¸ CategorÃ­a</mat-option>
              <mat-option value="priority">âš¡ Prioridad</mat-option>
              <mat-option value="member">ğŸ‘¤ Miembro</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- PerÃ­odo solo activo cuando Agrupar por = PerÃ­odo -->
          <mat-form-field *ngIf="form.value.dataSource === 'finance' && (form.value.groupBy === 'timeline' || !form.value.groupBy)" appearance="outline">
            <mat-label>PerÃ­odo</mat-label>
            <mat-select formControlName="period">
              <mat-option value="day">DÃ­a</mat-option>
              <mat-option value="week">Semana</mat-option>
              <mat-option value="month">Mes</mat-option>
              <mat-option value="year">AÃ±o</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Controles especÃ­ficos por fuente -->
          <ng-container *ngIf="form.value.dataSource === 'finance'">
            <mat-form-field appearance="outline">
              <mat-label>Moneda</mat-label>
              <mat-select formControlName="currency">
                <mat-option value="USD">ğŸ‡ºğŸ‡¸ USD</mat-option>
                <mat-option value="EUR">ğŸ‡ªğŸ‡º EUR</mat-option>
                <mat-option value="PEN">ğŸ‡µğŸ‡ª PEN</mat-option>
                <mat-option value="MXN">ğŸ‡²ğŸ‡½ MXN</mat-option>
                <mat-option value="COP">ğŸ‡¨ğŸ‡´ COP</mat-option>
                <mat-option value="CLP">ğŸ‡¨ğŸ‡± CLP</mat-option>
              </mat-select>
            </mat-form-field>

            <div class="checkbox-group">
              <mat-checkbox formControlName="includeExpenses">ğŸ’¸ Incluir gastos</mat-checkbox>
              <mat-checkbox formControlName="includeIncomes">ğŸ’° Incluir ingresos</mat-checkbox>
              <mat-checkbox formControlName="includeBalance">âš–ï¸ Incluir balance</mat-checkbox>
            </div>
          </ng-container>

          <!-- Secciones de Opciones Visuales y Avanzadas eliminadas segÃºn solicitud -->

          <div class="actions">
            <button mat-raised-button color="primary" (click)="generate()" [disabled]="loading()">
              <span *ngIf="!loading()">âœ¨ Generar GrÃ¡fica</span>
              <span *ngIf="loading()">â³ Generando...</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <mat-card class="preview-card">
      <mat-card-header>
        <mat-card-title>ğŸ‘ï¸ Vista Previa</mat-card-title>
        <mat-card-subtitle *ngIf="!loading()">
          Haz clic en cualquier punto para ver detalles
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="loading(); else chartTpl" class="loading">
          <span>Generando grÃ¡fica personalizada...</span>
        </div>
        <ng-template #chartTpl>
          <div class="chart-area">
            <div class="chart-scroll" [style.width.px]="computeChartWidth()">
              <canvas baseChart 
                      [type]="chartType" 
                      [data]="chartData" 
                      [options]="chartOptions" 
                      (chartClick)="onChartClick($event)">
              </canvas>
            </div>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Panel de detalle debajo del builder -->
  <mat-card class="detail-card" *ngIf="detailVisible()">
    <mat-card-header>
      <mat-card-title>
        ğŸ” Detalle del punto seleccionado
        <button mat-icon-button (click)="detailVisible.set(false)">
          <span>âœ•</span>
        </button>
      </mat-card-title>
      <mat-card-subtitle>
        <strong>Fuente:</strong> {{ selectedMeta()?.source === 'finance' ? 'ğŸ’° Finanzas' : 'âœ… Tareas' }}
        <span class="separator">â€¢</span>
        <strong>Agrupado por:</strong>
        <ng-container *ngIf="selectedMeta()?.groupBy === 'timeline'; else groupByText">
          ğŸ“… PerÃ­odo
        </ng-container>
        <ng-template #groupByText>{{ selectedMeta()?.groupBy }}</ng-template>
        <span class="separator">â€¢</span>
        <strong>Etiqueta:</strong> {{ selectedMeta()?.label }}
        <ng-container *ngIf="selectedMeta()?.period">
          <span class="separator">â€¢</span>
          <strong>PerÃ­odo:</strong> {{ selectedMeta()?.period }}
        </ng-container>
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- Resumen de datasets en ese punto -->
      <div class="summary-section">
        <h4>Resumen General</h4>
        <div class="summary-row">
          <div class="summary-item" *ngFor="let s of selectedSummary()">
            <div class="summary-label">{{ s.label }}</div>
            <div class="summary-value">{{ s.value | number:'1.2-2' }}</div>
          </div>
        </div>
      </div>

      <!-- Detalle especÃ­fico por fuente -->
      <ng-container *ngIf="selectedMeta()?.source === 'finance'; else tasksDetail">
        <div class="detail-columns">
          <!-- Solo mostrar secciÃ³n de gastos si estÃ¡n incluidos -->
          <div class="detail-col" *ngIf="form.value.includeExpenses">
            <h4>Gastos Detallados ({{ financeExpenses().length }})</h4>
            <div *ngIf="financeExpenses().length === 0" class="empty">
              No hay gastos registrados en este perÃ­odo
            </div>
            <ul class="list" *ngIf="financeExpenses().length > 0">
              <li *ngFor="let e of financeExpenses() | slice:0:15">
                <span class="amount negative">{{ e.amount | number:'1.2-2' }} {{ e.currency }}</span>
                <span class="meta">{{ e.categoryName || e.categoryId || 'Sin categorÃ­a' }}</span>
                <span class="date">{{ e.date | date:'dd/MM/yyyy':'UTC' }}</span>
              </li>
            </ul>
            <div *ngIf="financeExpenses().length > 15" class="more-items">
              y {{ financeExpenses().length - 15 }} transacciones mÃ¡s
            </div>
          </div>
          
          <!-- Solo mostrar secciÃ³n de ingresos si estÃ¡n incluidos -->
          <div class="detail-col" *ngIf="form.value.includeIncomes">
            <h4>Ingresos Detallados ({{ financeIncomes().length }})</h4>
            <div *ngIf="financeIncomes().length === 0" class="empty">
              No hay ingresos registrados en este perÃ­odo
            </div>
            <ul class="list" *ngIf="financeIncomes().length > 0">
              <li *ngFor="let i of financeIncomes() | slice:0:15">
                <span class="amount positive">{{ i.amount | number:'1.2-2' }} {{ i.currency }}</span>
                <span class="meta">{{ i.sourceName || i.source || i.sourceId || 'Sin fuente' }}</span>
                <span class="date">{{ i.date | date:'dd/MM/yyyy':'UTC' }}</span>
              </li>
            </ul>
            <div *ngIf="financeIncomes().length > 15" class="more-items">
              y {{ financeIncomes().length - 15 }} transacciones mÃ¡s
            </div>
          </div>
          
          <!-- Mensaje cuando no hay nada seleccionado -->
          <div class="detail-col full" *ngIf="!form.value.includeExpenses && !form.value.includeIncomes">
            <div class="empty">
              Selecciona "Incluir gastos" o "Incluir ingresos" en la configuraciÃ³n para ver detalles
            </div>
          </div>
        </div>
      </ng-container>
      
      <ng-template #tasksDetail>
        <div class="detail-columns">
          <div class="detail-col full">
            <h4>Listado de Tareas ({{ taskItems().length }})</h4>
            <div *ngIf="taskItems().length === 0" class="empty">
              No hay tareas que coincidan con este criterio
            </div>
            <ul class="list" *ngIf="taskItems().length > 0">
              <li *ngFor="let t of taskItems() | slice:0:15">
                <div class="task-row">
                  <span class="task-title">{{ t.title }}</span>
                  <div class="task-meta">
                    <span class="badge status-{{ t.status }}">{{ t.status }}</span>
                    <span class="badge priority-{{ t.priority }}">{{ t.priority }}</span>
                    <span *ngIf="t.dueDate" class="due-date">{{ t.dueDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>
              </li>
            </ul>
            <div *ngIf="taskItems().length > 15" class="more-items">
              y {{ taskItems().length - 15 }} tareas mÃ¡s
            </div>
          </div>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>