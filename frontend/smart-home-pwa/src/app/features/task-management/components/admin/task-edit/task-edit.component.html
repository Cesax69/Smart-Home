<div class="task-edit-container">
  <div class="header">
    <h1>✏️ Editar Tarea</h1>
    <button mat-stroked-button color="primary" (click)="close()">
      <mat-icon>close</mat-icon>
      Cerrar
    </button>
  </div>

  <mat-card class="edit-card">
    <mat-card-content>
      <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="task-form">
        <mat-accordion multi>
          <!-- Sección 1: Datos de la tarea -->
          <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>assignment</mat-icon>
                Datos de la tarea
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="form-grid">
              <!-- Título -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Título</mat-label>
                <input matInput formControlName="title" placeholder="Título de la tarea" />
                <mat-icon matSuffix>title</mat-icon>
                <mat-error *ngIf="taskForm.get('title')?.invalid && taskForm.get('title')?.touched">
                  {{ getErrorMessage('title') }}
                </mat-error>
              </mat-form-field>

              <!-- Descripción -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Descripción</mat-label>
                <textarea matInput formControlName="description" rows="4" placeholder="Describe la tarea"></textarea>
                <mat-icon matSuffix>description</mat-icon>
              </mat-form-field>

              <!-- Adjuntos -->
              <div class="attachments">
                <mat-card class="attachments-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>attach_file</mat-icon>
                      Adjuntos de la tarea
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="drop-zone" (click)="fileInput.click()" (dragover)="onDragOver($event)" (drop)="onDrop($event)">
                      <input #fileInput type="file" multiple (change)="onFilesSelected($event)" hidden />
                      <mat-icon>cloud_upload</mat-icon>
                      <p>Suelta archivos aquí o haz clic para seleccionar</p>
                    </div>

                    <!-- Archivos existentes -->
                    <div class="existing-files" *ngIf="existingFiles.length">
                      <h4>Archivos existentes</h4>
                      <div class="file-list">
                        <div class="file-item" *ngFor="let f of existingFiles">
                          <mat-icon>insert_drive_file</mat-icon>
                          <a [href]="f.fileUrl || f.webViewLink" target="_blank">{{ f.fileName }}</a>
                          <button mat-icon-button color="warn" (click)="removeExistingFile(f)">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Previsualizaciones nuevas -->
                    <div class="previews" *ngIf="filePreviews.length">
                      <h4>Nuevos archivos</h4>
                      <div class="preview-grid">
                        <mat-card class="preview-card" *ngFor="let preview of filePreviews">
                          <mat-card-header>
                            <mat-card-title>{{ preview.name }}</mat-card-title>
                            <mat-card-subtitle>{{ preview.size }}</mat-card-subtitle>
                          </mat-card-header>
                          <mat-card-content>
                            <div class="preview-thumb" *ngIf="preview.type === 'image'">
                              <img [src]="preview.url" alt="preview" />
                            </div>
                            <div class="preview-doc" *ngIf="preview.type === 'document'">
                              <mat-icon>description</mat-icon>
                            </div>
                          </mat-card-content>
                          <mat-card-actions>
                            <button mat-icon-button color="warn" (click)="removeFile(preview)">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </mat-card-actions>
                        </mat-card>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>
          </mat-expansion-panel>

          <!-- Sección 2: Plazos y asignaciones -->
          <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>event</mat-icon>
                Plazos y asignaciones
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Prioridad</mat-label>
                <mat-select formControlName="priority">
                  <mat-option value="low">Baja</mat-option>
                  <mat-option value="medium">Media</mat-option>
                  <mat-option value="high">Alta</mat-option>
                </mat-select>
                <mat-icon matSuffix>priority_high</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Fecha límite</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="dueDate" />
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Asignados</mat-label>
                <mat-select formControlName="assignedUserIds" multiple>
                  <mat-option *ngFor="let m of familyMembers" [value]="m.id">
                    {{ m.firstName }} {{ m.lastName }}
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>group</mat-icon>
              </mat-form-field>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <div class="actions">
          <button mat-stroked-button type="button" (click)="close()" [disabled]="submitting">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="taskForm.invalid || submitting">
            <mat-icon>save</mat-icon>
            Guardar cambios
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>